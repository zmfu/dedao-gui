name: Build Windows EXE (Cache Attempt)

on:
  workflow_dispatch: # åªä¿ç•™æ‰‹åŠ¨è§¦å‘
  push:              
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1. ç¬¬ä¸€æ¬¡æ¿€æ´»ç¯å¢ƒ (ç”¨äº npm install)
      - name: Setup MSVC for Install
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ğŸ‘‡ã€æ–°å¢ã€‘æ‰“å°å³å°†ä½¿ç”¨çš„ Cache Key
      - name: Debug Cache Key
        shell: pwsh
        run: |
          $lockHash = "${{ hashFiles('**/package-lock.json') }}"
          $fullKey = "Windows-npm-$lockHash"
          Write-Host "ğŸ”‘ Calculated Cache Key: $fullKey"
          Write-Host "ğŸ“„ Lock files found:"
          Get-ChildItem -Recurse -Filter "package-lock.json" | ForEach-Object { Write-Host "  - $($_.FullName)" }

      # 1. ç¼“å­˜æ­¥éª¤
      - name: Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: |
            dd-server/node_modules
            dd-vue/node_modules
            ~/.npm
          # ğŸ‘‡ æ˜¾å¼å†™å‡º OS åç§°ï¼Œé¿å… runner.os æ½œåœ¨çš„å¤§å°å†™é—®é¢˜
          key: Windows-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            Windows-npm-

      # 2. è°ƒè¯•æ­¥éª¤ (å¢å¼ºç‰ˆ)
      - name: Debug Cache Hit
        shell: pwsh
        run: |
          $hit = "${{ steps.cache-node-modules.outputs.cache-hit }}"
          if ($hit -eq "true") {
            Write-Host "âœ… CACHE HIT!"
          } elseif ($hit -eq "false") {
            Write-Host "âŒ CACHE MISS (Found old cache but key mismatch)"
          } else {
            Write-Host "âš ï¸ CACHE MISS (No cache found at all) - Status: '$hit'"
          }
          
          Write-Host "ğŸ“‚ Checking node_modules existence:"
          if (Test-Path "dd-server/node_modules") { Write-Host "  âœ… dd-server/node_modules exists" } else { Write-Host "  âŒ dd-server/node_modules MISSING" }
          if (Test-Path "dd-vue/node_modules") { Write-Host "  âœ… dd-vue/node_modules exists" } else { Write-Host "  âŒ dd-vue/node_modules MISSING" }

      - name: Install Dependencies
        shell: pwsh # æ˜¾å¼æŒ‡å®šä½¿ç”¨ PowerShell
        run: |
          Write-Host "Starting npm ci..."
          
          # PowerShell æŸ¥çœ‹å†…å­˜ (å•ä½ MB)
          $mem = Get-CimInstance Win32_OperatingSystem
          Write-Host "Free Physical Memory: $($mem.FreePhysicalMemory / 1MB) MB"
          
          # --- ä¿®æ”¹å¼€å§‹ï¼šåˆ†åˆ«è¿›å…¥å­ç›®å½•æ‰§è¡Œ ---
          
          # 1. å¤„ç† dd-server
          Write-Host "ğŸ‘‰ Installing dependencies for dd-server..."
          Set-Location dd-server
          npm config set registry https://registry.npmmirror.com
          npm ci --loglevel verbose --progress=false --prefer-offline
          Set-Location .. # è¿”å›æ ¹ç›®å½•
          
          # 2. å¤„ç† dd-vue
          Write-Host "ğŸ‘‰ Installing dependencies for dd-vue..."
          Set-Location dd-vue
          npm config set registry https://registry.npmmirror.com
          npm ci --loglevel verbose --progress=false --prefer-offline
          Set-Location .. # è¿”å›æ ¹ç›®å½•
          
          # --- ä¿®æ”¹ç»“æŸ ---
          
          Write-Host "âœ… All dependencies installed successfully."
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          
      - name: Build Frontend (Vue/Vite)
        shell: pwsh
        run: |
          Write-Host "ğŸ—ï¸ Building frontend project..."
          Set-Location dd-vue
          npm config set registry https://registry.npmmirror.com
          # è¿è¡Œæ„å»ºå‘½ä»¤ï¼Œç”Ÿæˆ dist/ ç›®å½•
          npm run build 
          Set-Location ..
          
          Write-Host "âœ… Frontend build completed."
          Write-Host "ğŸ“‚ Verifying dist folder:"
          if (Test-Path "dd-vue/dist/index.html") {
            Write-Host "  âœ… dd-vue/dist/index.html found!"
          } else {
            Write-Host "  âŒ ERROR: dist/index.html NOT found!"
            exit 1 # å¦‚æœæ²¡ç”Ÿæˆï¼Œç›´æ¥è®©æ„å»ºå¤±è´¥ï¼Œé¿å…æ‰“åŒ…ç©ºå£³
          }          

      # 2. ã€å…³é”®ã€‘ç¬¬äºŒæ¬¡æ¿€æ´»ç¯å¢ƒ (ç”¨äº electron-builder å†…éƒ¨çš„å­è¿›ç¨‹)
      # è¿™ä¸€æ­¥éå¸¸é‡è¦ï¼Œå› ä¸º electron-builder ä¼š spawn æ–°è¿›ç¨‹
      - name: Setup MSVC for Build
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build Electron App
        run: |
          cd dd-server
          # å› ä¸ºç¯å¢ƒå˜é‡å·²ç»ç”±ä¸Šä¸€æ­¥çš„ msvc-dev-cmd é…å¥½äº†ï¼Œè¿™æ¬¡ç¼–è¯‘ä¸€å®šä¼šæˆåŠŸ
          npx electron-builder --windows --config.npmRebuild=false
        shell: pwsh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dd-client-installer-win64
          path: dd-server/dist/*.exe
          if-no-files-found: error