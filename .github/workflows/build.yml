name: Build Windows EXE

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1. 下载代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 安装 Node.js 20
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. 【新增】配置 Visual Studio 环境
      # 告诉 node-gyp 使用已安装的 VS 2022，并设置必要的变量
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # 4. 安装依赖 (此时环境已准备好，sqlite3 应该能编译)
      - name: Install Dependencies
        run: |
          cd dd-server
          # 设置 npm 使用镜像加速
          npm config set registry https://registry.npmmirror.com
          npm install
          
          cd ../dd-vue
          npm config set registry https://registry.npmmirror.com
          npm install

      # 5. 构建前端 (Vue)
      - name: Build Frontend
        run: |
          cd dd-vue
          npm run build
          cp -r dist/* ../dd-server/

      # 6. 打包 Electron
      - name: Build Electron App
        run: |
          cd dd-server
          npm run dist:win

      # 7. 上传产物
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dd-client-installer
          path: dd-server/dist/*.exe