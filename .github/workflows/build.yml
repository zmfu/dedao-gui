name: Build Windows EXE (Cache Attempt)

on:
  workflow_dispatch: # åªä¿ç•™æ‰‹åŠ¨è§¦å‘
  push:              # ğŸ‘ˆ ä¸´æ—¶åŠ ä¸Šè¿™ä¸ª
    branches: [ "cache" ] # ğŸ‘ˆ æŒ‡å®š cache åˆ†æ”¯

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1. ç¬¬ä¸€æ¬¡æ¿€æ´»ç¯å¢ƒ (ç”¨äº npm install)
      - name: Setup MSVC for Install
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ğŸ‘‡ ä¿®æ­£ç‰ˆï¼šè°ƒè¯•æ­¥éª¤ (ä½¿ç”¨ PowerShell è¯­æ³•)
      - name: Debug Cache Status
        shell: pwsh # æ˜¾å¼æŒ‡å®šä½¿ç”¨ PowerShell
        run: |
          Write-Host "Cache Hit Status: ${{ steps.cache-node-modules.outputs.cache-hit }}"
          Write-Host "Node Modules Size Check:"
          
          if (Test-Path "node_modules") {
            $size = (Get-ChildItem "node_modules" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
            Write-Host "node_modules size: $($size.ToString('F2')) MB"
            Get-ChildItem "node_modules" | Select-Object -First 5 Name
          } else {
            Write-Host "node_modules directory does not exist yet."
          }
          
          Write-Host "Memory Info (SystemInfo):"
          systeminfo | findstr /C:"Total Physical Memory" /C:"Available Physical Memory"

      - name: Install Dependencies
        shell: pwsh # æ˜¾å¼æŒ‡å®šä½¿ç”¨ PowerShell
        run: |
          Write-Host "Starting npm ci..."
          
          # PowerShell æŸ¥çœ‹å†…å­˜ (å•ä½ MB)
          $mem = Get-CimInstance Win32_OperatingSystem
          Write-Host "Free Physical Memory: $($mem.FreePhysicalMemory / 1MB) MB"
          
          # æ‰§è¡Œ npm ci
          # --loglevel verbose: å¼ºåˆ¶è¾“å‡ºè¯¦ç»†æ—¥å¿—
          # --progress=false: é˜²æ­¢è¿›åº¦æ¡åˆ·å±
          npm ci --loglevel verbose --progress=false --prefer-offline
          
          Write-Host "Install finished successfully."
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      # 2. ã€å…³é”®ã€‘ç¬¬äºŒæ¬¡æ¿€æ´»ç¯å¢ƒ (ç”¨äº electron-builder å†…éƒ¨çš„å­è¿›ç¨‹)
      # è¿™ä¸€æ­¥éå¸¸é‡è¦ï¼Œå› ä¸º electron-builder ä¼š spawn æ–°è¿›ç¨‹
      - name: Setup MSVC for Build
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build Electron App
        run: |
          cd dd-server
          # å› ä¸ºç¯å¢ƒå˜é‡å·²ç»ç”±ä¸Šä¸€æ­¥çš„ msvc-dev-cmd é…å¥½äº†ï¼Œè¿™æ¬¡ç¼–è¯‘ä¸€å®šä¼šæˆåŠŸ
          npx electron-builder --windows --config.npmRebuild=false
        shell: pwsh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dd-client-installer-win64
          path: dd-server/dist/*.exe
          if-no-files-found: error