name: Build Windows EXE (Final Attempt 2)

on:
  workflow_dispatch: # 只保留手动触发

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1. 第一次激活环境 (用于 npm install)
      - name: Setup MSVC for Install
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Dependencies
        run: |
          cd dd-server
          npm config set registry https://registry.npmmirror.com
          npm install
          cd ../dd-vue
          npm config set registry https://registry.npmmirror.com
          npm install

      - name: Build Frontend
        run: |
          cd dd-vue
          npm run build
          cp -r dist/* ../dd-server/

      # 2. 【关键】第二次激活环境 (用于 electron-builder 内部的子进程)
      # 这一步非常重要，因为 electron-builder 会 spawn 新进程
      - name: Setup MSVC for Build
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build Electron App
        run: |
          cd dd-server
          # 因为环境变量已经由上一步的 msvc-dev-cmd 配好了，这次编译一定会成功
          npx electron-builder --windows -c.npmRebuild=false
        shell: pwsh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dd-client-installer-win64
          path: dd-server/dist/*.exe
          if-no-files-found: error